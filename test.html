<!-- Security Awareness Mini-Quiz (3 Qs) -->
<div id="secquiz" style="max-width:640px;margin:1rem 0;padding:16px;border:1px solid #ddd;border-radius:12px;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;">
  <h3 style="margin:0 0 12px;">Security Check: 3 Quick Questions</h3>
  <div id="sq-status" style="font-size:14px;opacity:.8;margin-bottom:8px;"></div>
  <div id="sq-card" style="padding:12px;border:1px solid #eee;border-radius:10px;">
    <div id="sq-question" style="font-weight:600;line-height:1.4;"></div>
    <ol id="sq-choices" type="A" style="margin-top:10px;padding-left:20px;"></ol>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
      <button id="sq-submit" style="padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fafafa;cursor:pointer;">Submit</button>
      <button id="sq-hint" style="padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fafafa;cursor:pointer;">Hint</button>
      <button id="sq-skip" style="padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fafafa;cursor:pointer;">Skip</button>
    </div>

    <div id="sq-feedback" style="margin-top:10px;"></div>
  </div>

  <div id="sq-finish" style="display:none;margin-top:14px;padding:12px;border:1px dashed #ddd;border-radius:10px;"></div>
</div>

<script>
(() => {
  // --- Tiny curated bank (3 questions) ---
  const BANK = [
    {
      id: "easy-1", topic: "phishing", difficulty: 1,
      prompt: `You receive an email from "payroll@acme-payrolls.com" about updating direct deposit. 
The company domain you use everywhere else is "acmepayroll.com". What should you do?`,
      choices: [
        "Click the link quickly before the window expires.",
        "Reply asking them to resend the link.",
        "Verify via a known channel (e.g., HR portal or bookmarked link) and report the email.",
        "Forward it to coworkers to ask if it’s real."
      ],
      correct: 2,
      hint: "Look closely at the sender domain; use a known-good path instead of links in the email.",
      rationale: "The sender domain is look-alike. Don’t click links or reply. Use a trusted path (e.g., HR portal) and report the phish."
    },
    {
      id: "medium-1", topic: "qr-phish", difficulty: 2,
      prompt: `A poster in the office lobby advertises “Free security training — scan to earn swag!” 
The QR code points to a shortened URL. What’s the safest next step?`,
      choices: [
        "Scan it and proceed if the page looks professional.",
        "Type the destination shown after expanding the short link into your browser.",
        "Report the poster to Security/Facilities; access training via your official LMS link instead.",
        "Ask a colleague if they already scanned it."
      ],
      correct: 2,
      hint: "Short links can hide malicious destinations. Prefer official, known-good entry points.",
      rationale: "Treat in-the-wild QR codes like unknown links. Report it and use your official LMS/bookmark instead."
    },
    {
      id: "hard-1", topic: "bec-wire", difficulty: 3,
      prompt: `In Teams, someone named “CEO (Mobile)” messages: “Urgent: wire $47,800 to a new vendor before close. 
Use this account number now — don’t call, I’m in a board meeting.” What do you do next?`,
      choices: [
        "Comply immediately; urgency implies legitimacy.",
        "Ask for the vendor W-9 over chat to verify.",
        "Call the CEO or finance lead using a known number to verify; follow standard approval workflow.",
        "Split the payment to reduce risk."
      ],
      correct: 2,
      hint: "Urgency + payment change + ‘don’t verify’ are classic BEC indicators.",
      rationale: "This matches Business Email Compromise patterns. Verify out-of-band with a known number and follow the normal approval process."
    }
  ];

  // --- Simple adaptive sequencing: start at easy (1); step up/down based on performance ---
  const byDifficulty = (d) => BANK.filter(q => q.difficulty === d);
  const state = {
    askedIds: new Set(),
    current: null,
    currentIndex: 0,
    score: 0,
    usedHint: false,
    startTime: 0,
    difficulty: 1, // start easy
    total: 3,
    history: [] // {id, correct, time, usedHint, difficulty}
  };

  const el = (id) => document.getElementById(id);
  const $status = el('sq-status');
  const $question = el('sq-question');
  const $choices = el('sq-choices');
  const $feedback = el('sq-feedback');
  const $finish = el('sq-finish');
  const $submit = el('sq-submit');
  const $hint = el('sq-hint');
  const $skip = el('sq-skip');

  function formatStatus() {
    $status.textContent = `Progress: ${state.currentIndex}/${state.total} • Score: ${state.score}`;
  }

  function pickNextQuestion() {
    // Candidate pool by current difficulty, then fallbacks if exhausted
    const tiers = [state.difficulty, 2, 1, 3].filter((v,i,a)=>a.indexOf(v)===i);
    for (const d of tiers) {
      const pool = byDifficulty(d).filter(q => !state.askedIds.has(q.id));
      if (pool.length) {
        return pool[Math.floor(Math.random() * pool.length)];
      }
    }
    return null;
  }

  function renderQuestion(q) {
    state.current = q;
    state.usedHint = false;
    state.startTime = performance.now();
    $feedback.innerHTML = '';
    $question.textContent = q.prompt;
    $choices.innerHTML = '';
    q.choices.forEach((c, idx) => {
      const li = document.createElement('li');
      const id = `sq-opt-${idx}`;
      li.style.margin = '6px 0';
      li.innerHTML = `
        <label style="cursor:pointer;display:flex;gap:8px;align-items:flex-start;">
          <input type="radio" name="sq-choice" value="${idx}" id="${id}" style="margin-top:4px;">
          <span>${c}</span>
        </label>
      `;
      $choices.appendChild(li);
    });
  }

  function stepDifficulty(lastCorrect, timeMs, usedHint) {
    // Simple heuristic: reward fast, correct, no-hint → step up; else adjust down toward 1..3
    if (lastCorrect && timeMs < 30000 && !usedHint) state.difficulty = Math.min(3, state.difficulty + 1);
    else if (!lastCorrect) state.difficulty = Math.max(1, state.difficulty - 1);
    // keep within 1..3
    if (state.difficulty < 1) state.difficulty = 1;
    if (state.difficulty > 3) state.difficulty = 3;
  }

  function finish() {
    const correctCt = state.history.filter(h => h.correct).length;
    const avgTime = state.history.reduce((s,h)=>s+h.time,0) / state.history.length / 1000;
    const topTip = (() => {
      if (state.history.some(h => h.usedHint)) return "Great curiosity—next time try spotting 1–2 red flags before using the hint.";
      if (avgTime < 12 && correctCt === 3) return "Strong detection skills! Consider mentoring teammates on BEC and QR risks.";
      return "Remember: verify via known-good channels and never act on urgent payment changes in chat/email.";
    })();

    $finish.style.display = 'block';
    $finish.innerHTML = `
      <strong>All done!</strong><br>
      Correct: ${correctCt}/3 • Avg time: ${avgTime.toFixed(1)}s<br>
      <div style="margin-top:8px">${topTip}</div>
      <details style="margin-top:8px">
        <summary>Review</summary>
        <ol style="margin-top:6px;padding-left:20px;">
          ${state.history.map(h => {
            const q = BANK.find(x=>x.id===h.id);
            const letter = String.fromCharCode(65 + q.correct);
            return `<li style="margin:6px 0">
              <div><em>${q.prompt.replace(/\n/g,' ')}</em></div>
              <div><strong>${h.correct ? 'Correct' : 'Not quite'}</strong> • Right answer: ${letter}. ${q.rationale}</div>
            </li>`;
          }).join('')}
        </ol>
      </details>
    `;
    // Disable controls
    $submit.disabled = true; $hint.disabled = true; $skip.disabled = true;
  }

  function next() {
    if (state.currentIndex >= state.total) return finish();
    const q = pickNextQuestion();
    if (!q) return finish();
    state.askedIds.add(q.id);
    state.currentIndex += 1;
    formatStatus();
    renderQuestion(q);
  }

  $submit.addEventListener('click', () => {
    const selected = document.querySelector('input[name="sq-choice"]:checked');
    if (!selected) {
      $feedback.innerHTML = `<div style="color:#a00;">Please select an option.</div>`;
      return;
    }
    const chosen = Number(selected.value);
    const elapsed = performance.now() - state.startTime;
    const correct = chosen === state.current.correct;

    // Scoring: +1 for correct; slight penalty if hint used; small time bonus for fast correct (<15s)
    let delta = 0;
    if (correct) {
      delta = 1;
      if (elapsed < 15000 && !state.usedHint) delta += 0.1;
    }
    if (state.usedHint) delta -= 0.1;
    state.score = Math.max(0, +(state.score + delta).toFixed(2));

    state.history.push({
      id: state.current.id,
      correct,
      time: elapsed,
      usedHint: state.usedHint,
      difficulty: state.current.difficulty
    });

    $feedback.innerHTML = `
      <div style="padding:8px;border:1px solid ${correct?'#cfe9cf':'#f2caca'};background:${correct?'#f6fff6':'#fff6f6'};border-radius:8px;">
        <strong>${correct ? 'Nice catch!' : 'Not quite.'}</strong><br>
        ${state.current.rationale}
      </div>
    `;

    stepDifficulty(correct, elapsed, state.usedHint);

    // Move to next after brief pause
    setTimeout(() => {
      if (state.currentIndex >= state.total) finish();
      else next();
    }, 900);
  });

  $hint.addEventListener('click', () => {
    state.usedHint = true;
    $feedback.innerHTML = `<div style="padding:8px;border:1px dashed #ddd;border-radius:8px;"><strong>Hint:</strong> ${state.current.hint}</div>`;
  });

  $skip.addEventListener('click', () => {
    // Treat skip as incorrect but without penalty to score; adjust difficulty down slightly
    state.history.push({
      id: state.current.id, correct: false, time: performance.now() - state.startTime,
      usedHint: state.usedHint, difficulty: state.current.difficulty
    });
    state.difficulty = Math.max(1, state.difficulty - 1);
    next();
  });

  // Kick off
  formatStatus();
  next();
})();
</script>
